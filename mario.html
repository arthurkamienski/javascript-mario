<!DOCTYPE html>
<html>
<canvas id="canvas" width="1000" height="400"></canvas>

<img id="idle_right" style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/idle_right.png">
<img id="idle_left"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/idle_left.png">
<img id="jump_right" style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/jump_right.png">
<img id="jump_left"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/jump_left.png">
<img id="walk_right" style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/walk_right.png">
<img id="walk_left"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/walk_left.png">
<img id="fall_right" style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/fall_right.png">
<img id="fall_left"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/fall_left.png">
<img id="down_right" style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/down_right.png">
<img id="down_left"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/down_left.png">
<img id="coin_cube"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/coin_cube.png">
<img id="spent_coin_cube"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/spent_coin_cube.png">
<img id="green_tube"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/green_tube.png">
<img id="ground"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/regular_ground.png">
<img id="background"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/reg_background.png">

<script>

  var canvas;
  var canvasContext;

  var gravity = 1;
  var atrict = 1/4;
  var fps = 30;
  var mario;
  var ground;

  function Mario() {
  	this.side = "right";
  	this.state = "idle";
  	this.img = document.getElementById(this.state + "_" + this.side);
  	this.pos = {x:canvas.width/2, y:ground};
  	this.speed = {x:0, y:0};
  	this.tick = 0;
  	this.down = false;

  	this.setImage = function() { 
  		this.tick++;
  		this.tick %= 2;

  		if(this.pos.y>=ground) {
  			if(this.speed.x != 0) {
  				if(this.tick == 0) {
  					if(this.state == "idle") { 
  						this.state = "walk";
  					} else {
  						this.state = "idle";
  					}
  				}
  			} else {
  				if(this.down)
  					this.state = "down";
  				else
  					this.state = "idle";
  			}
  		} else {
  			if(this.speed.y < 0)
  				this.state = "jump";
  			else
  				this.state = "fall";
  		}

  		this.img = document.getElementById(this.state + "_" + this.side);
  	}
  }

  window.onload = function() {

    canvas = document.getElementById('canvas');
    canvasContext = canvas.getContext('2d');

    ground = canvas.height-document.getElementById('ground').height;
    mario = new Mario();
    
    setInterval(iteration, 1000/fps);

    document.addEventListener('keydown', move);
    document.addEventListener('keyup', stop);
  }

  function move(evt) {
    switch(evt.keyCode) {
      case 37:
        mario.speed.x = -7;
        mario.side = "left";
        break;
      case 38:
        jump();
        break;
      case 39:
        mario.speed.x = 7;
        mario.side = "right";
        break;
      case 40:
      	mario.down = true;
      	break;
    }
  }

  function stop(evt) {
    if(evt.keyCode == 37){
    	if(mario.speed.x < 0) {
    		mario.speed.x = 0;
    	}
    } else if (evt.keyCode == 39) {
    	if(mario.speed.x > 0) {
    		mario.speed.x = 0;
    	}
    }
    else if(evt.keyCode == 40) {
    	mario.down = false;
    }
  }

  function jump() {
    if(mario.pos.y == ground) {
      mario.speed.y = -20;
  	}
  }

  function applyGravity() {
    mario.speed.y += gravity;
  }

  function updatePosition() {
    mario.pos.x += mario.speed.x;
    mario.pos.y += mario.speed.y;

    if(mario.pos.y>=ground) {
      mario.pos.y = ground;
      // mario.speed.y = -mario.speed.y/1.6;
    }

    if(mario.pos.y<=0) {
      mario.pos.y = 0;
      // mario.speed.y = -mario.speed.y/1.3;
    }

    if(mario.pos.x+mario.img.width>=canvas.width) {
      mario.pos.x = canvas.width-mario.img.width;
      // mario.speed.x = -mario.speed.x/1.3;
    } else if(mario.pos.x<=0) {
      mario.pos.x = 0;
      // mario.speed.x = -mario.speed.x/1.3;
    }
  }

  function iteration() {
    applyGravity();
    updatePosition();
    mario.setImage();
    draw();
  }

  function drawGround() {
  	var groundtile = document.getElementById("ground");

  	var start = 0;

  	while(start < canvas.width) {
  		canvasContext.drawImage(groundtile, start, ground);
  		start += groundtile.width;
  	}
  }

  function drawBackground() {
  	var background = document.getElementById("background");
  	var start = 0;

  	while(start < canvas.width) {
  		canvasContext.drawImage(background, start, 0);
  		start += background.width;
  	}
  }

  function drawObject(id, pos) {
  	var obj = document.getElementById(id);

  	canvasContext.drawImage(obj, pos.x, pos.y-obj.height);
  }

  function draw() {
  	drawBackground();
    drawGround();

    drawObject("green_tube", {x:50, y:ground});
    drawObject("coin_cube", {x:750, y:canvas.height-200});

	canvasContext.drawImage(mario.img, mario.pos.x, mario.pos.y-mario.img.height);
  }

</script>
</html>