<!DOCTYPE html>
<html>
<canvas id="canvas" width="1000" height="400"></canvas>

<img id="idle_right" style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/idle_right.png">
<img id="idle_left"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/idle_left.png">
<img id="jump_right" style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/jump_right.png">
<img id="jump_left"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/jump_left.png">
<img id="walk_right" style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/walk_right.png">
<img id="walk_left"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/walk_left.png">
<img id="fall_right" style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/fall_right.png">
<img id="fall_left"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/fall_left.png">
<img id="down_right" style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/down_right.png">
<img id="down_left"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/down_left.png">
<img id="coin_cube"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/coin_cube.png">
<img id="spent_coin_cube"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/spent_coin_cube.png">
<img id="green_tube"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/green_tube.png">
<img id="ground"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/regular_ground.png">
<img id="background"  style="display: none;" src="https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sprites/reg_background.png">

<script>

  var canvas;
  var canvasContext;

  var gravity = 1;
  var atrict = 1/4;
  var fps = 30;
  var mario;
  var ground;
  var objects = [];

  function Mario() {
    this.side = "right";
    this.state = "idle";
    this.img = document.getElementById(this.state + "_" + this.side);
    this.pos = {x:canvas.width/2, y:ground};
    this.speed = {x:0, y:0};
    this.tick = 0;
    this.down = false;
    this.hb = new Hitbox(this.pos, this.img);

    this.setImage = function() { 
      this.tick++;
      this.tick %= 2;

      if(this.speed.x > 0)
      this.side = "right";
    else if(this.speed.x < 0)
      this.side = "left";

      if(this.speed.y == 0) {
        if(this.speed.x != 0) {
          if(this.tick == 0) {
            if(this.state == "idle") { 
              this.state = "walk";
            } else {
              this.state = "idle";
            }
          }
        } else {
          if(this.down)
            this.state = "down";
          else
            this.state = "idle";
        }
      } else {
        if(this.speed.y < 0)
          this.state = "jump";
        else
          this.state = "fall";
      }

      this.img = document.getElementById(this.state + "_" + this.side);
    }
  }

  function Object(id, pos) {
      this.spec = id;
      this.img = document.getElementById(id); 
      this.pos = pos;
      this.hb = new Hitbox(this.pos, this.img);

      this.move = function() {}
  }

  function CoinCube(id, pos) {
    Object.call(this, id, pos);

    this.speed = 0;
    this.anchor = this.pos.y;

    this.hit = function() {
      this.speed = -4;
      new sound("https://raw.githubusercontent.com/arthurkamienski/javascript-mario/master/sounds/coin.wav").play();
    }

    function sound(src) {
      this.sound = document.createElement("audio");
      this.sound.src = src;
      this.sound.setAttribute("preload", "auto");
      this.sound.setAttribute("controls", "none");
      this.sound.style.display = "none";
      document.body.appendChild(this.sound);
      this.play = function(){
          this.sound.play();
      }
      this.stop = function(){
          this.sound.pause();
    }
}

    this.move = function() {
      this.pos.y += this.speed;

      if(this.anchor-this.pos.y>=10)
        this.speed = -this.speed;
      else if(this.anchor == this.pos.y)
        this.speed = 0;

      this.hb = new Hitbox(this.pos, this.img);
    }
  }

    function Hitbox(pos, img) {
    this.t = pos.y-img.height;
    this.b = pos.y;
    this.l = pos.x-img.width/2;
    this.r = pos.x+img.width/2;
    this.tl = {x: this.l, y: this.t};
    this.tr = {x: this.r, y: this.t};
    this.bl = {x: this.l, y: this.b};
    this.br = {x: this.r, y: this.b};
  }


  window.onload = function() {

    canvas = document.getElementById('canvas');
    canvasContext = canvas.getContext('2d');

    ground = canvas.height-document.getElementById('ground').height;
    mario = new Mario();

    objects.push(new Object("green_tube", {x:100, y:ground}));
    objects.push(new CoinCube("coin_cube", {x:750, y:canvas.height-180}));
    
    setInterval(iteration, 1000/fps);

    document.addEventListener('keydown', move);
    document.addEventListener('keyup', stop);
  }

  function move(evt) {
    switch(evt.keyCode) {
      case 37:
        mario.speed.x = -7;
        break;
      case 38:
        jump();
        break;
      case 39:
        mario.speed.x = 7;
        break;
      case 40:
        mario.down = true;
        break;
    }
  }

  function stop(evt) {
    if(evt.keyCode == 37){
      if(mario.speed.x < 0) {
        mario.speed.x = 0;
      }
    } else if (evt.keyCode == 39) {
      if(mario.speed.x > 0) {
        mario.speed.x = 0;
      }
    }
    else if(evt.keyCode == 40) {
      mario.down = false;
    }
  }

  function jump() {
    if(mario.state == "idle" || mario.state == "walk") {
      mario.speed.y = -20;
    }
  }

  function applyGravity() {
      mario.speed.y += gravity;
  }

  function moveAll() {
    mario.pos.x += mario.speed.x;
    mario.pos.y += mario.speed.y;

    mario.hb = new Hitbox(mario.pos, mario.img);

    for (var i = objects.length - 1; i >= 0; i--) {
      objects[i].move();
    }
  }

  function updatePosition() {

    if(mario.hb.b>=ground) {
      mario.pos.y = ground;
      mario.speed.y = 0;
      // mario.speed.y = -mario.speed.y/1.6;
    }

    if(mario.hb.t <= 0) {
      mario.pos.y = mario.img.height;
      mario.speed.y = -mario.speed.y/1.3;
    }

    if(mario.hb.r>=canvas.width) {
      mario.pos.x = canvas.width-mario.img.width/2;
      // mario.speed.x = -mario.speed.x/1.3;
    } else if(mario.hb.l<=0) {
      mario.pos.x = mario.img.width/2;
      // mario.speed.x = -mario.speed.x/1.3;
    }

    for (var i = objects.length - 1; i >= 0; i--) {
      var o = objects[i];

      if(collision(mario.hb, o.hb)) {
        var side = getMinSideDist(mario.hb, o.hb);

        switch(side) {
          case "b":
            mario.pos.y = o.hb.t;
            mario.speed.y = 0;
            break;
          case "t":
            mario.pos.y = o.hb.b+mario.img.height;
            mario.speed.y = -mario.speed.y/1.3;
            if(o.spec == "coin_cube") {
              o.hit();
            }
            break
          case "r":
            mario.pos.x = o.hb.l-mario.img.width/2;
            break;
          case "l":
            mario.pos.x = o.hb.r+mario.img.width/2;
            break;
        }
      }
    }

    mario.hb = new Hitbox(mario.pos, mario.img);

  }

  function getMinSideDist(sqr1, sqr2) {
    b = Math.abs(sqr1.b-sqr2.t);
    t = Math.abs(sqr1.t-sqr2.b);
    l = Math.abs(sqr1.l-sqr2.r);
    r = Math.abs(sqr1.r-sqr2.l);

    min = Math.min(b, t, l, r);

    var side;

    switch(min) {
      case b:
        side = "b";
        break;
      case t:
        side = "t";
        break;
      case l:
        side = "l";
        break;
      case r:
        side = "r";
        break;
    }

    return side;
  }

  function collision(sqr1, sqr2) {
    var collision = true;

    if(sqr1.l > sqr2.r || sqr2.l > sqr1.r)
      collision = false;

    if(sqr1.t > sqr2.b || sqr2.t > sqr1.b)
        collision = false;

    return collision;
  }

  function iteration() {
    applyGravity();
    moveAll();
    updatePosition();
    mario.setImage();
    draw();
  }

  function drawGround() {
    var groundtile = document.getElementById("ground");

    var start = 0;

    while(start < canvas.width) {
      canvasContext.drawImage(groundtile, start, ground);
      start += groundtile.width;
    }
  }

  function drawBackground() {
    var background = document.getElementById("background");
    var start = 0;

    while(start < canvas.width) {
      canvasContext.drawImage(background, start, 0);
      start += background.width;
    }
  }

  function drawObjects() {
    for (var i = objects.length - 1; i >= 0; i--) {
      var o = objects[i];
      canvasContext.drawImage(o.img, o.hb.l, o.hb.t);
    }
  }

  function draw() {
    drawBackground();
    drawGround();
    drawObjects();

  canvasContext.drawImage(mario.img, mario.hb.l, mario.hb.t);
  }

  window.addEventListener("keydown", function(e) {
    // space and arrow keys
    if([32, 37, 38, 39, 40].indexOf(e.keyCode) > -1) {
        e.preventDefault();
    }
}, false);

</script>
</html>